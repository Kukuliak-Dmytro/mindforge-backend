# Завдання з розробки API для Mind Forge

## Загальні інструкції

### Архітектура
- Всі контролери наслідують базовий клас `BaseController`
- Стандартна структура відповіді:
  ```typescript
  {
    message: string;
    data?: any;
    errors?: ValidationError[];
  }
  ```
- Всі ID користувачів беруться з JWT токена (`req.user.id`)
- Використовувати Zod для валідації
- Всі помилки обробляються через централізований error handler

### Типи помилок
- `ValidationError` - помилки валідації даних
- `AuthenticationError` - помилки автентифікації
- `AuthorizationError` - помилки авторизації
- `NotFoundError` - ресурс не знайдено
- `ConflictError` - конфлікт даних
- `DatabaseError` - помилки бази даних

### Структура проекту
```
src/
  ├── controllers/     # Контролери
  ├── services/       # Бізнес-логіка
   ├──    config     # Конфіг, щоб уникнути магічних чисел
  ├── repositories/   # Робота з БД
  ├── middlewares/    # Middleware
  ├── types/         # Типи та інтерфейси
  ├── utils/         # Утиліти
  └── validators/    # Схеми валідації
```

## Група 0: Підготовка бази даних

### Міграція схеми відгуків
- [ ] Оновлення схеми Prisma
  - Файл: `prisma/schema.prisma`
  - Додати enum ReviewStatus
  - Оновити модель Review
  - Додати унікальний індекс
  - Перевірити зв'язки з іншими моделями

- [ ] Створення міграції
  - Команда: `npx prisma migrate dev --name update_review_system`
  - Ця команда:
    1. Створить новий файл міграції в `prisma/migrations`
    2. Застосує зміни до бази даних
    3. Згенерує оновлений Prisma Client
  - Перевірити створений файл міграції
  - Перевірити що всі зміни коректні

- [ ] Оновлення типів
  - Команда: `npx prisma generate`
  - Перевірити оновлені типи в `node_modules/.prisma/client`
  - Оновити імпорти в коді де використовується Review

- [ ] Тестування міграції
  - Перевірити що існуючі відгуки отримали статус PENDING
  - Перевірити що унікальний індекс працює
  - Перевірити що всі зв'язки працюють коректно

### Пояснення змін
1. **ReviewStatus enum**
   - PENDING: новий відгук на модерації
   - PUBLISHED: відгук опублікований
   - REJECTED: відгук відхилений модератором

2. **Нові поля в Review**
   - status: статус відгуку (enum)
   - tutorResponse: відповідь репетитора
   - publishedAt: дата публікації
   - updatedAt: дата останнього оновлення

3. **Унікальний індекс**
   - Запобігає створенню декількох відгуків на одне замовлення
   - Додається через `@@unique([orderId])`

4. **Зв'язки**
   - Зберігаються всі існуючі зв'язки з Order та User
   - Додаються нові поля для відстеження статусу

### Важливі моменти
1. Міграція не втратить існуючі дані
2. Всі існуючі відгуки отримають статус PENDING
3. Потрібно оновити код, який працює з відгуками
4. Міграцію можна відкотити командою `npx prisma migrate reset`

## Група 1: Аутентифікація та Профілі

### Аутентифікація
Авторизація реалізована на фронтенді через Supabase. Тут на бекенді варто лише валідувати токени і дивитися чи роль користувача правильна

### Профілі користувачів
- [ ] Отримання профілю
  - Endpoint: `GET /api/profile`
  - Включення додаткової інформації залежно від ролі
 - зберігатти лише айді аватара 1-6, на основі якого буде відображатися аватар з тих, які є на сайті

- [ ] Оновлення профілю
  - Endpoint: `PUT /api/profile`
  - Валідація: firstName, lastName, phone, bio
  - зберігатти лише айді аватара 1-6, на основі якого буде відображатися аватар з тих, які є на сайті
  - в алежності від ролі, різна валідація



## Група 2: Репетитори

### Каталог репетиторів
- [ ] Отримання списку всіх репетиторів (каталог)
  - Endpoint: `GET /api/tutors`
  - Обов'язкова фільтрація:
    - за предметами (масив subjectIds)
    - за категоріями (масив categoryIds)
  - Опціональна фільтрація:
    - за рейтингом (minRating)
    - за ціною (minPrice, maxPrice)
    - за наявністю вільних слотів
  - Сортування (опціонально):
    - за рейтингом
    - за ціною
    - за кількістю відгуків
  - Пагінація ( створити утіліту або метод класу)
  - Включення:
    - базова інформація
    - рейтинг
    - кількість відгуків
    - список предметів з цінами
    - кількість активних замовлень

- [ ] Пошук репетиторів
  - Endpoint: `GET /api/tutors/search`
  - Обов'язкові параметри:
    - предмети (масив subjectIds)
    - категорії (масив categoryIds)
  - Опціональні параметри:
    - текстовий пошук (ім'я, прізвище)
    - фільтри як в каталозі
  - Повертає ті ж дані що й каталог

### Освіта репетитора
- [ ] Отримати список всіх освіт
    - зробити блок, дозволити лише до 5 освіт
- [ ] Додавання освіти
  - Endpoint: `POST /api/tutors/education`
  - Валідація: institution, fieldOfStudy, degree, startDate, endDate

- [ ] Оновлення освіти
  - Endpoint: `PUT /api/tutors/education/:educationId`
  - Валідація: всі поля освіти

- [ ] Видалення освіти
  - Endpoint: `DELETE /api/tutors/education/:educationId`

### Досвід репетитора
- [ ] Отримати список всіх досвідів
    - зробити блок, дозволити лише до 5 досвідів

- [ ] Додавання досвіду
  - Endpoint: `POST /api/tutors/experience`
  - Валідація: institution, title, startDate, endDate

- [ ] Оновлення досвіду
  - Endpoint: `PUT /api/tutors/experience/:experienceId`
  - Валідація: всі поля досвіду

- [ ] Видалення досвіду
  - Endpoint: `DELETE /api/tutors/experience/:experienceId`

### Предмети репетитора
- [ ] Додавання предмету
  - Endpoint: `POST /api/tutors/subjects`
  - Валідація: subjectId, hourlyRate

- [ ] Оновлення ціни
  - Endpoint: `PUT /api/tutors/subjects/:subjectId`
  - Валідація: hourlyRate

- [ ] Видалення предмету
  - Endpoint: `DELETE /api/tutors/subjects/:subjectId`

## Група 3: Замовлення

### Управління замовленнями
- [ ] Створення замовлення
  - Endpoint: `POST /api/orders`
  - Валідація: subjectId, categoryId, title, description, sessionsCount
  - Розрахунок totalPrice

- [ ] Отримання списку замовлень
  - Endpoint: `GET /api/orders`
  - Фільтрація за статусом
  - Пагінація
  - Сортування

- [ ] Отримання списку замовлень користувача (студента)
  - Endpoint: `GET /api/orders/my/student`
  - Обов'язкова фільтрація:
    - за предметами (масив subjectIds)
    - за категоріями (масив categoryIds)
  - Опціональна фільтрація:
    - за статусом (активні, завершені, скасовані)
    - за датою створення
  - Сортування (опціонально):
    - за датою створення
    - за статусом
  - Пагінація
  - Включення:
    - інформація про репетитора
    - предмет
    - статус
    - дати сесій

- [ ] Отримання списку замовлень репетитора
  - Endpoint: `GET /api/orders/my/tutor`
  - Обов'язкова фільтрація:
    - за предметами (масив subjectIds)
    - за категоріями (масив categoryIds)
  - Опціональна фільтрація:
    - за статусом
    - за датою
    - за студентом
  - Сортування (опціонально):
    - за датою створення
    - за статусом
  - Пагінація
  - Включення:
    - інформація про студента
    - предмет
    - статус
    - дати сесій

- [ ] Отримання статистики замовлень
  - Endpoint: `GET /api/orders/statistics`
  - Для репетитора:
    - кількість активних замовлень
    - кількість завершених замовлень
    - середній рейтинг
    - загальна сума заробітку
  - Для студента:
    - кількість активних замовлень
    - кількість завершених замовлень
    - загальна сума витрат

- [ ] Отримання деталей замовлення
  - Endpoint: `GET /api/orders/:orderId`
  - Включення: студент, репетитор, предмет, сесії, чат

- [ ] Оновлення статусу замовлення
  - Endpoint: `PATCH /api/orders/:orderId/status`
  - Валідація: статус
  - Нотифікації

- [ ] Скасування замовлення
  - Endpoint: `POST /api/orders/:orderId/cancel`
  - Валідація: причина скасування
  - Нотифікації

### Сесії
- [ ] Створення сесії
  - Endpoint: `POST /api/orders/:orderId/sessions`
  - Валідація: scheduledStart, scheduledEnd
  - Генерація meetingLink

- [ ] Оновлення статусу сесії
  - Endpoint: `PATCH /api/sessions/:sessionId/status`
  - Валідація: статус, actualStart, actualEnd

- [ ] Отримання календаря сесій
  - Endpoint: `GET /api/sessions/calendar`
  - Фільтрація за датою
  - Групування по днях

## Група 4: Відгуки та Рейтинги

### Відгуки
- [ ] Створення відгуку
  - Endpoint: `POST /api/orders/:orderId/reviews`
  - Валідація:
    - перевірка що замовлення завершене
    - перевірка що відгук ще не створений
    - rating (1-5)
    - comment (опціонально, мінімум 10 символів)
  - Автоматична модерація:
    - перевірка на спам
    - перевірка на неприйнятний контент
  - Оновлення середнього рейтингу репетитора

- [ ] Отримання відгуків репетитора
  - Endpoint: `GET /api/tutors/:tutorId/reviews`
  - Фільтрація:
    - за статусом (опціонально)
    - за рейтингом (опціонально)
  - Пагінація
  - Сортування за датою
  - Включення:
    - інформація про студента
    - відповідь репетитора
    - дата публікації

- [ ] Відповідь репетитора на відгук
  - Endpoint: `PUT /api/reviews/:reviewId/response`
  - Валідація:
    - тільки для опублікованих відгуків
    - тільки власник відгуку (репетитор)
    - мінімум 10 символів
  - Оновлення updatedAt

- [ ] Модерація відгуків (для адмінів)
  - Endpoint: `PATCH /api/admin/reviews/:reviewId/moderate`
  - Валідація:
    - новий статус
    - причина відхилення (якщо REJECTED)
  - Оновлення:
    - статус
    - publishedAt (якщо PUBLISHED)
    - updatedAt

- [ ] Отримання статистики відгуків
  - Endpoint: `GET /api/tutors/:tutorId/reviews/statistics`
  - Включення:
    - середній рейтинг
    - кількість відгуків по рейтингах (1-5)
    - кількість відгуків по статусах
    - відсоток позитивних відгуків (4-5 зірок)

### Обмеження та правила
1. Відгук можна створити тільки після завершення замовлення
2. Один відгук на замовлення
3. Відгук проходить модерацію перед публікацією
4. Репетитор може відповісти на опублікований відгук
5. Адміністратори можуть модерувати відгуки
6. Відгуки не можна видаляти, тільки модерувати

## Група 5: Чати та Повідомлення

### Чати
- [ ] Створення чату
  - Endpoint: `POST /api/orders/:orderId/chat`
  - Автоматичне створення при створенні замовлення

- [ ] Отримання списку чатів
  - Endpoint: `GET /api/chats`
  - Фільтрація за статусом замовлення
  - Сортування за останнім повідомленням

- [ ] Отримання списку всіх чатів користувача
  - Endpoint: `GET /api/chats/my`
  - Обов'язкова фільтрація:
    - за предметами (масив subjectIds)
    - за категоріями (масив categoryIds)
  - Опціональна фільтрація:
    - за статусом замовлення
    - за наявністю непрочитаних повідомлень
    - за датою останнього повідомлення
  - Сортування (опціонально):
    - за датою останнього повідомлення
    - за статусом замовлення
  - Пагінація
  - Включення:
    - інформація про співрозмовника
    - останнє повідомлення
    - кількість непрочитаних
    - статус замовлення

- [ ] Отримання статистики чатів
  - Endpoint: `GET /api/chats/statistics`
  - Кількість активних чатів
  - Кількість непрочитаних повідомлень
  - Остання активність

### Повідомлення
- [ ] Відправка повідомлення
  - Endpoint: `POST /api/chats/:chatId/messages`
  - Валідація: content
  - Real-time оновлення через Supabase

- [ ] Отримання історії повідомлень
  - Endpoint: `GET /api/chats/:chatId/messages`
  - Пагінація
  - Сортування за датою

- [ ] Позначення повідомлень як прочитаних
  - Endpoint: `PATCH /api/chats/:chatId/messages/read`
  - Real-time оновлення статусу

## Додаткові завдання

### Оптимізація
- [ ] Впровадження кешування для часто запитуваних даних
- [ ] Оптимізація запитів до бази даних
- [ ] Впровадження rate limiting

### Безпека
- [ ] Впровадження CORS політики через список, який оголошується в config
- [ ] Налаштування заголовків безпеки
- [ ] Валідація всіх вхідних даних
- [ ] Логування важливих операцій

## Зміни в схемі бази даних

### Оновлення моделі Review
```prisma
enum ReviewStatus {
  PENDING    // на модерації
  PUBLISHED  // опублікований
  REJECTED   // відхилений
}

model Review {
  id            String      @id @default(uuid())
  orderId       String
  studentId     String
  tutorId       String
  rating        Int
  comment       String?
  status        ReviewStatus @default(PENDING)
  tutorResponse String?     // відповідь репетитора
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  publishedAt   DateTime?   // дата публікації

  order         Order       @relation(fields: [orderId], references: [id])
  student       User        @relation("StudentReviews", fields: [studentId], references: [id])
  tutor         User        @relation("TutorReviews", fields: [tutorId], references: [id])

  @@unique([orderId]) // один відгук на замовлення
}
```

 